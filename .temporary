  /**
   * 按条件映射查询
   * 
   * @param clazz 实例类
   * @param column 映射列名
   * @param propertyName 条件名
   * @param value 条件值
   * @return
   */
  protected Object projectionQuery(Class<?> clazz, String column, String propertyName, String value) {
    Session session = HibernateUtil.getSessionFactory().openSession();
    Transaction transaction = session.beginTransaction();

    try {
      transaction.begin();

      // 创建条件容器并添加条件
      Criteria criteria = session.createCriteria(clazz);
      criteria.add(Restrictions.eq(propertyName, value));

      // 创建映射列表并添加映射列
      ProjectionList projectionList = Projections.projectionList();
      projectionList.add(Projections.property(column));
      criteria.setProjection(projectionList);

      List<?> activitys = (List<?>) criteria.list();
      
      transaction.commit();
      session.close();

      return activitys.size() == 0 ? ((Object []) activitys.get(0))[0] : null;
      } catch (HibernateException e) {
        e.printStackTrace();
        return null;
      }
  }

server {
  listen 80;
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  root /home/mxsyx/desktop/vote/target/vote;
 
  location = / {
    rewrite ^(.*)$ http://$host/index permanent;
  }

  location ~ ^(/template|/WEB-INF) {
  	deny all;
  }
  
  location ~ ^(/vote|/user|/index|/admin|/api) {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://127.0.0.1:8080;
  }

  location ~ \.(css|js|jpg|png|woff|woff2|ttf|svg)$ {
    #expires 12h;    # 静态文件过期时间
    access_log off;  # 不记录静态文件访问志
  }
}


package org.vote.api.vote;

import java.io.File;
import java.io.IOException;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;

import org.vote.beans.Activity;
import org.vote.common.BaseApi;
import org.vote.common.UUIDTool;
import org.vote.common.Utils;

/**
 * 处理创建活动
 */
@WebServlet("/api/vote/publish")
public class Publish extends BaseApi {
  private static final long serialVersionUID = 1L;

  public Publish() {
  }

  protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    String uid = userIdentify(request, response);
    if (uid == null) {
      complete(response, 1003);
      return ;
    }

    // 只处理 multipart 类型的表单数据
    boolean multipart = ServletFileUpload.isMultipartContent(request);
    if (multipart) {
      Activity activity = new Activity();

      // 设置发布者
      activity.setPublisher(Long.valueOf(uid));

      // 创建磁盘文件工厂
      DiskFileItemFactory factory = new DiskFileItemFactory();

      // 设置缓冲区大小
      factory.setSizeThreshold(1024 * 1024 * 2);

      // 创建文件上传处理器
      ServletFileUpload upload = new ServletFileUpload(factory);

      // 单个文件大小不超过1M
      upload.setFileSizeMax(1024 * 1024);

      try {
        List<FileItem> items = upload.parseRequest(request);
        Iterator<FileItem> iter = items.iterator();

        while (iter.hasNext()) {
          FileItem item = iter.next();

          if (item.isFormField()) { // 普通表单数据
            // 表单名
            String fieldName = item.getFieldName();

            // 表单值
            String fieldContent = item.getString("UTF-8");

            if (fieldName.equals("title")) {
              activity.setTitle(fieldContent);
            } else if (fieldName.equals("suffix")) {
              activity.setSuffix(fieldContent);
            } else if (fieldName.equals("quantifier")) {
              activity.setQuantifier(fieldContent);
            } else if (fieldName.equals("summary")) {
              activity.setSummary(fieldContent);
            } else if (fieldName.equals("voteTimeStart")) {
              activity.setVoteTimeStart(new Date(Long.parseLong(fieldContent)));
            } else if (fieldName.equals("voteTimeEnd")) {
              activity.setVoteTimeEnd(new Date(Long.parseLong(fieldContent)));
            } else if (fieldName.equals("signUpTimeStart")) {
              activity.setApplyTimeStart(new Date(Long.parseLong(fieldContent)));
            } else if (fieldName.equals("signUpTimeEnd")) {
              activity.setApplyTimeEnd(new Date(Long.parseLong(fieldContent)));
            } else if (fieldName.equals("maximum")) {
              activity.setMaximum(Integer.parseInt(fieldContent));
            } else if (fieldName.equals("options")) {
              activity.setOptions(fieldContent);
            }
          } else { // 文件数据
            String filename = item.getName();
            String ext = filename.substring(filename.indexOf(".") + 1);

            // 文件后缀名不为 jpg/png
            if (!ext.equals("jpg") && !ext.equals("png")) {
              complete(response, 1002);
              return ;
            }

            // 定义上传文件路径
            String basePath = request.getSession().getServletContext().getRealPath("/") + "uploads/";
            String fullPath = Utils.mkdirByDate(basePath);

            // 定义本机存储的文件名
            String localFileName =  UUIDTool.getUUID() + "." + ext;
            activity.setImgMain(fullPath.substring(fullPath.indexOf("/uploads")) + "/" + localFileName);

            // 存储文件
            File file = new File(fullPath, localFileName);
            item.write(file);
          }
        }

        // 设置UUID主键
        activity.setId(UUIDTool.getUUID());

        // 执行数据存储
        if (createTicketTable(activity.getId()) && saveInstance(activity)) {
          complete(response, 1000);
        } else {
          complete(response, 1001);
        }
      } catch (Exception e) {
        e.printStackTrace();
        complete(response, 1001);
      }
    }
  }  

  /**
   * 创建投票表
   * 
   * @param aid 活动ID
   * @return 创建投票表成功/失败
   */
  private boolean createTicketTable(String aid) {
    // 调用创建投票表事务
    String hql = "call create_ticket_table(:uuid)";
    String[] keys = {"uuid"}, values = {aid};
    return dbExcute(hql, keys, values);
  }
}
